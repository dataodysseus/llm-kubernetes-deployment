name: Deploy to AWS App Runner

on:
  push:
    branches:
      - main
    paths:
      - 'databricks-genie/genie-fastapi-app-aws/**'  # Only trigger on changes to this directory
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: genie-fastapi
  APP_RUNNER_SERVICE_NAME: genie-fastapi-service
  WORKING_DIRECTORY: databricks-genie/genie-fastapi-app-aws  # Add this

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug OIDC Token
        run: |
          echo "GitHub Repository: ${{ github.repository }}"
          echo "GitHub Ref: ${{ github.ref }}"
          echo "GitHub SHA: ${{ github.sha }}"
          echo "Expected sub: repo:${{ github.repository }}:ref:${{ github.ref }}"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image to ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Change to the correct directory
          cd ${{ env.WORKING_DIRECTORY }}
          
          # Build Docker image
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          # Push to ECR
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Deploy to App Runner
        env:
          IMAGE_URI: ${{ steps.build-image.outputs.image }}
        run: |
          # Check if service exists
          SERVICE_ARN=$(aws apprunner list-services \
            --region ${{ env.AWS_REGION }} \
            --query "ServiceSummaryList[?ServiceName=='${{ env.APP_RUNNER_SERVICE_NAME }}'].ServiceArn" \
            --output text)
          
          if [ -z "$SERVICE_ARN" ]; then
            echo "Creating new App Runner service..."
            
            aws apprunner create-service \
              --service-name ${{ env.APP_RUNNER_SERVICE_NAME }} \
              --region ${{ env.AWS_REGION }} \
              --source-configuration "{
                \"ImageRepository\": {
                  \"ImageIdentifier\": \"${IMAGE_URI}\",
                  \"ImageRepositoryType\": \"ECR\",
                  \"ImageConfiguration\": {
                    \"Port\": \"8080\",
                    \"RuntimeEnvironmentVariables\": {
                      \"DATABRICKS_HOST\": \"${{ secrets.DATABRICKS_HOST }}\",
                      \"DATABRICKS_TOKEN\": \"${{ secrets.DATABRICKS_TOKEN }}\",
                      \"SPACE_ID\": \"${{ secrets.GENIE_SPACE_ID }}\"
                    }
                  }
                },
                \"AutoDeploymentsEnabled\": false,
                \"AuthenticationConfiguration\": {
                  \"AccessRoleArn\": \"${{ secrets.APP_RUNNER_ACCESS_ROLE_ARN }}\"
                }
              }" \
              --instance-configuration '{
                "Cpu": "1024",
                "Memory": "2048"
              }' \
              --health-check-configuration '{
                "Protocol": "HTTP",
                "Path": "/health",
                "Interval": 10,
                "Timeout": 5,
                "HealthyThreshold": 1,
                "UnhealthyThreshold": 5
              }'
              
            echo "‚úÖ Service created successfully"
            
          else
              echo "Updating existing App Runner service..."
              echo "Service ARN: $SERVICE_ARN"
              
              aws apprunner update-service \
                --service-arn $SERVICE_ARN \
                --region us-east-1 \
                --source-configuration "{
                  \"ImageRepository\": {
                    \"ImageIdentifier\": \"${IMAGE_URI}\",
                    \"ImageRepositoryType\": \"ECR\",
                    \"ImageConfiguration\": {
                      \"Port\": \"8080\",
                      \"RuntimeEnvironmentVariables\": {
                        \"DATABRICKS_HOST\": \"${{ secrets.DATABRICKS_HOST }}\",
                        \"DATABRICKS_TOKEN\": \"${{ secrets.DATABRICKS_TOKEN }}\",
                        \"SPACE_ID\": \"${{ secrets.GENIE_SPACE_ID }}\"
                      }
                    }
                  },
                  \"AutoDeploymentsEnabled\": false,
                  \"AuthenticationConfiguration\": {
                    \"AccessRoleArn\": \"${{ secrets.APP_RUNNER_ACCESS_ROLE_ARN }}\"
                  }
                }"
              
              echo "‚úÖ Service updated successfully. App Runner is deploying the new image!"
            fi

            echo "=========================================="
            echo "‚è≥ Waiting for App Runner deployment to stabilize..."
            echo "=========================================="

            # Set up our polling variables (Wait up to 15 minutes)
            WAIT_INTERVAL=20
            MAX_WAIT=900
            ELAPSED=0

            while [ $ELAPSED -lt $MAX_WAIT ]; do
              # Fetch the current status of the service
              SERVICE_STATUS=$(aws apprunner describe-service \
                --service-arn $SERVICE_ARN \
                --region us-east-1 \
                --query "Service.Status" \
                --output text)
              
              if [ "$SERVICE_STATUS" == "RUNNING" ]; then
                echo ""
                echo "‚úÖ Deployment successful! Service is now RUNNING."
                
                # Grab and display the live URL
                SERVICE_URL=$(aws apprunner describe-service \
                  --service-arn $SERVICE_ARN \
                  --region us-east-1 \
                  --query "Service.ServiceUrl" \
                  --output text)
                
                echo "üåê Live URL: https://$SERVICE_URL"
                echo "ü©∫ Health Check: https://$SERVICE_URL/health"
                echo "üìñ Swagger UI: https://$SERVICE_URL/docs"
                exit 0
                
              elif [[ "$SERVICE_STATUS" == *"FAILED"* ]] || [[ "$SERVICE_STATUS" == "DELETED" ]]; then
                echo ""
                echo "‚ùå Deployment failed. App Runner reached status: $SERVICE_STATUS"
                echo "Please check the AWS App Runner Event Logs in the AWS Console for the exact reason."
                exit 1
              fi
              
              echo "Current status: $SERVICE_STATUS... checking again in ${WAIT_INTERVAL}s (Elapsed: ${ELAPSED}s / ${MAX_WAIT}s)"
              sleep $WAIT_INTERVAL
              ELAPSED=$((ELAPSED + WAIT_INTERVAL))
            done

            echo ""
            echo "‚ö†Ô∏è Deployment timed out in GitHub Actions after 15 minutes."
            echo "The service might still be deploying in AWS. Check the AWS Console."
            exit 1

      - name: Wait for deployment to complete
        run: |
          SERVICE_ARN=$(aws apprunner list-services \
            --region ${{ env.AWS_REGION }} \
            --query "ServiceSummaryList[?ServiceName=='${{ env.APP_RUNNER_SERVICE_NAME }}'].ServiceArn" \
            --output text)
          
          echo "Waiting for service to be running..."
          
          for i in {1..30}; do
            STATUS=$(aws apprunner describe-service \
              --service-arn $SERVICE_ARN \
              --region ${{ env.AWS_REGION }} \
              --query 'Service.Status' \
              --output text)
            
            echo "Attempt $i/30: Service status is $STATUS"
            
            if [ "$STATUS" == "RUNNING" ]; then
              echo "‚úÖ Service is running!"
              break
            fi
            
            if [ "$STATUS" == "CREATE_FAILED" ] || [ "$STATUS" == "UPDATE_FAILED" ]; then
              echo "‚ùå Deployment failed with status: $STATUS"
              exit 1
            fi
            
            sleep 30
          done

      - name: Get App Runner URL
        run: |
          SERVICE_ARN=$(aws apprunner list-services \
            --region ${{ env.AWS_REGION }} \
            --query "ServiceSummaryList[?ServiceName=='${{ env.APP_RUNNER_SERVICE_NAME }}'].ServiceArn" \
            --output text)
          
          SERVICE_URL=$(aws apprunner describe-service \
            --service-arn $SERVICE_ARN \
            --region ${{ env.AWS_REGION }} \
            --query 'Service.ServiceUrl' \
            --output text)
          
          echo "=========================================="
          echo "üöÄ Deployment Complete!"
          echo "=========================================="
          echo "Service URL: https://$SERVICE_URL"
          echo "Health Check: https://$SERVICE_URL/health"
          echo "API Docs: https://$SERVICE_URL/docs"
          echo "Swagger JSON: https://$SERVICE_URL/swagger.json"
          echo "=========================================="