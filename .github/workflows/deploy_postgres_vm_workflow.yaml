# GitHub Actions Workflow: Deploy PostgreSQL on GCP Compute Engine (e2-micro)
# Free tier eligible. Uses same OIDC/Workload Identity Federation as Cloud Run workflow.
# Trigger: Manual only (workflow_dispatch)

name: Deploy PostgreSQL VM on GCP

on:
  workflow_dispatch:
    inputs:
      vm_name:
        description: 'VM instance name'
        required: true
        default: 'postgres-vm'
        type: string
      region:
        description: 'GCP region'
        required: true
        default: 'us-central1'
        type: string
      zone:
        description: 'GCP zone'
        required: true
        default: 'us-central1-a'
        type: string
      db_name:
        description: 'PostgreSQL database name to create'
        required: true
        default: 'appdb'
        type: string
      recreate_vm:
        description: 'Delete and recreate VM if it already exists'
        required: false
        default: false
        type: boolean

jobs:
  deploy-postgres:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Authenticate with Workload Identity Federation
        uses: google-github-actions/auth@v2
        with:
          project_id: "${{ secrets.GCP_PROJECT_ID }}"
          workload_identity_provider: "${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}"
          service_account: "${{ secrets.GCP_SERVICE_ACCOUNT }}"

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: "${{ secrets.GCP_PROJECT_ID }}"

      - name: Enable Required GCP Services
        run: |
          echo "üîß Enabling required GCP services..."
          gcloud services enable compute.googleapis.com
          gcloud services enable oslogin.googleapis.com
          echo "‚úÖ Services enabled"

      # -------------------------------------------------------
      # Firewall: allow PostgreSQL port 5432 from anywhere
      # -------------------------------------------------------
      - name: Create Firewall Rule for PostgreSQL
        run: |
          RULE_NAME="allow-postgres-5432"
          if gcloud compute firewall-rules describe $RULE_NAME --quiet 2>/dev/null; then
            echo "‚ÑπÔ∏è Firewall rule '$RULE_NAME' already exists, skipping."
          else
            echo "üîß Creating firewall rule to open port 5432..."
            gcloud compute firewall-rules create $RULE_NAME \
              --allow tcp:5432 \
              --target-tags postgres-server \
              --source-ranges 0.0.0.0/0 \
              --description "Allow external PostgreSQL access"
            echo "‚úÖ Firewall rule created"
          fi

      # -------------------------------------------------------
      # VM: create e2-micro with Ubuntu 22.04 (free tier)
      # -------------------------------------------------------
      - name: Create or Reuse VM
        run: |
          VM_NAME=${{ inputs.vm_name }}
          ZONE=${{ inputs.zone }}
          RECREATE=${{ inputs.recreate_vm }}

          VM_EXISTS=$(gcloud compute instances list \
            --filter="name=${VM_NAME} AND zone:${ZONE}" \
            --format="value(name)" 2>/dev/null)

          if [[ -n "$VM_EXISTS" ]]; then
            if [[ "$RECREATE" == "true" ]]; then
              echo "‚ôªÔ∏è Deleting existing VM '${VM_NAME}'..."
              gcloud compute instances delete ${VM_NAME} --zone ${ZONE} --quiet
            else
              echo "‚ÑπÔ∏è VM '${VM_NAME}' already exists. Skipping creation (set recreate_vm=true to replace it)."
              exit 0
            fi
          fi

          echo "üñ•Ô∏è Creating e2-micro VM with Ubuntu 22.04..."
          gcloud compute instances create ${VM_NAME} \
            --zone ${ZONE} \
            --machine-type e2-micro \
            --image-family ubuntu-2204-lts \
            --image-project ubuntu-os-cloud \
            --boot-disk-size 30GB \
            --boot-disk-type pd-standard \
            --tags postgres-server \
            --metadata enable-oslogin=TRUE \
            --scopes https://www.googleapis.com/auth/cloud-platform

          echo "‚úÖ VM created"
          echo "‚è≥ Waiting 30s for VM to initialize..."
          sleep 30

      # -------------------------------------------------------
      # Install PostgreSQL
      # -------------------------------------------------------
      - name: Install PostgreSQL on VM
        run: |
          gcloud compute ssh ${{ inputs.vm_name }} \
            --zone ${{ inputs.zone }} \
            --tunnel-through-iap \
            --command "
              set -e
              sudo apt-get update -qq
              sudo apt-get install -y curl ca-certificates gnupg

              # Add official PostgreSQL apt repository (PGDG)
              curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc \
                | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/postgresql.gpg
              echo 'deb http://apt.postgresql.org/pub/repos/apt jammy-pgdg main' \
                | sudo tee /etc/apt/sources.list.d/pgdg.list

              sudo apt-get update -qq
              sudo apt-get install -y postgresql-15 postgresql-contrib-15

              sudo systemctl enable postgresql
              sudo systemctl start postgresql
              echo done
            "
          echo "‚úÖ PostgreSQL 15 installed and running"

      # -------------------------------------------------------
      # Configure remote access
      # -------------------------------------------------------
      - name: Configure PostgreSQL for Remote Access
        run: |
          DB_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}"

          gcloud compute ssh ${{ inputs.vm_name }} \
            --zone ${{ inputs.zone }} \
            --tunnel-through-iap \
            --command "
              set -e
              sudo -u postgres psql -c \"ALTER USER postgres PASSWORD '${DB_PASSWORD}';\"
              PG_CONF=\$(sudo -u postgres psql -t -c 'SHOW config_file;' | xargs)
              sudo sed -i \"s/#listen_addresses = 'localhost'/listen_addresses = '*'/\" \$PG_CONF
              PG_HBA=\$(sudo -u postgres psql -t -c 'SHOW hba_file;' | xargs)
              echo 'host    all             all             0.0.0.0/0               md5' | sudo tee -a \$PG_HBA
              sudo systemctl restart postgresql
              echo done
            "
          echo "‚úÖ Remote access configured"

      # -------------------------------------------------------
      # Write SQL to a temp file on the runner, scp to VM,
      # then execute ‚Äî avoids all heredoc/YAML escaping issues
      # -------------------------------------------------------
      - name: Write SQL Seed File
        run: |
          DB_NAME=${{ inputs.db_name }}

          cat > /tmp/seed.sql << ENDSQL
          SELECT 'CREATE DATABASE ${DB_NAME}' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = '${DB_NAME}')\gexec
          \connect ${DB_NAME}

          CREATE SCHEMA IF NOT EXISTS sales;

          CREATE TABLE IF NOT EXISTS sales.customers (
            customer_id  SERIAL        PRIMARY KEY,
            name         VARCHAR(100)  NOT NULL,
            email        VARCHAR(150)  UNIQUE NOT NULL,
            country      VARCHAR(60)   NOT NULL,
            created_at   TIMESTAMP     DEFAULT NOW()
          );

          CREATE TABLE IF NOT EXISTS sales.products (
            product_id   SERIAL        PRIMARY KEY,
            name         VARCHAR(100)  NOT NULL,
            category     VARCHAR(60),
            unit_price   NUMERIC(10,2) NOT NULL
          );

          CREATE TABLE IF NOT EXISTS sales.orders (
            order_id     SERIAL        PRIMARY KEY,
            customer_id  INT           REFERENCES sales.customers(customer_id),
            product_id   INT           REFERENCES sales.products(product_id),
            quantity     INT           NOT NULL CHECK (quantity > 0),
            total_amount NUMERIC(12,2) NOT NULL,
            order_date   DATE          DEFAULT CURRENT_DATE
          );

          INSERT INTO sales.customers (name, email, country) VALUES
            ('Alice Johnson', 'alice@example.com', 'USA'),
            ('Bob Smith',     'bob@example.com',   'Canada'),
            ('Clara Diaz',    'clara@example.com', 'Mexico'),
            ('David Lee',     'david@example.com', 'UK'),
            ('Eva Muller',    'eva@example.com',   'Germany')
          ON CONFLICT (email) DO NOTHING;

          INSERT INTO sales.products (name, category, unit_price) VALUES
            ('Laptop Pro 15',   'Electronics', 1299.99),
            ('Wireless Mouse',  'Electronics',   29.99),
            ('Standing Desk',   'Furniture',    499.00),
            ('USB-C Hub',       'Electronics',   49.99),
            ('Ergonomic Chair', 'Furniture',    349.00)
          ON CONFLICT DO NOTHING;

          INSERT INTO sales.orders (customer_id, product_id, quantity, total_amount, order_date) VALUES
            (1, 1, 1, 1299.99, '2024-01-15'),
            (1, 2, 2,   59.98, '2024-01-16'),
            (2, 3, 1,  499.00, '2024-02-01'),
            (3, 4, 3,  149.97, '2024-02-10'),
            (4, 5, 1,  349.00, '2024-02-14'),
            (5, 1, 1, 1299.99, '2024-03-01'),
            (2, 2, 1,   29.99, '2024-03-05')
          ON CONFLICT DO NOTHING;

          SELECT 'customers' AS tbl, COUNT(*) FROM sales.customers
          UNION ALL SELECT 'products', COUNT(*) FROM sales.products
          UNION ALL SELECT 'orders',   COUNT(*) FROM sales.orders;
          ENDSQL

          echo "‚úÖ SQL file written"

      - name: Copy SQL File to VM
        run: |
          gcloud compute scp /tmp/seed.sql ${{ inputs.vm_name }}:/tmp/seed.sql \
            --zone ${{ inputs.zone }} \
            --tunnel-through-iap
          echo "‚úÖ SQL file copied to VM"

      - name: Execute SQL on VM
        run: |
          gcloud compute ssh ${{ inputs.vm_name }} \
            --zone ${{ inputs.zone }} \
            --tunnel-through-iap \
            --command "sudo -u postgres psql -f /tmp/seed.sql && rm /tmp/seed.sql"
          echo "‚úÖ Schema, tables, and seed data created"

      # -------------------------------------------------------
      # Print connection details
      # -------------------------------------------------------
      - name: Print Connection Summary
        run: |
          VM_NAME=${{ inputs.vm_name }}
          ZONE=${{ inputs.zone }}
          DB_NAME=${{ inputs.db_name }}

          PUBLIC_IP=$(gcloud compute instances describe ${VM_NAME} \
            --zone ${ZONE} \
            --format 'value(networkInterfaces[0].accessConfigs[0].natIP)')

          echo ""
          echo "=========================================="
          echo "üéâ DEPLOYMENT SUCCESSFUL"
          echo "=========================================="
          echo ""
          echo "üåê VM Public IP:   ${PUBLIC_IP}"
          echo "üóÑÔ∏è  Database:      ${DB_NAME}"
          echo "üîå Port:           5432"
          echo "üë§ User:           postgres"
          echo "üîë Password:       (stored in POSTGRES_PASSWORD secret)"
          echo ""
          echo "üìã Connection String:"
          echo "   postgresql://postgres:<password>@${PUBLIC_IP}:5432/${DB_NAME}"
          echo ""
          echo "üìã Schema Overview:"
          echo "   ‚Ä¢ sales.customers  ‚Äî 5 rows seeded"
          echo "   ‚Ä¢ sales.products   ‚Äî 5 rows seeded"
          echo "   ‚Ä¢ sales.orders     ‚Äî 7 rows seeded"
          echo ""
          echo "üß™ Quick test from your machine:"
          echo "   psql postgresql://postgres:<password>@${PUBLIC_IP}:5432/${DB_NAME} -c 'SELECT * FROM sales.orders;'"
          echo ""
          echo "‚ö†Ô∏è  SECURITY REMINDER:"
          echo "   Port 5432 is open to 0.0.0.0/0."
          echo "   Restrict the firewall rule to your IP once connectivity is confirmed."
          echo ""
          echo "üí∞ Cost Estimate (e2-micro, us-central1):"
          echo "   ‚Ä¢ Compute: FREE (GCP free tier)"
          echo "   ‚Ä¢ Disk 30GB pd-standard: ~\$1.20/mo"
          echo "   ‚Ä¢ Egress: minimal for low traffic"
          echo "=========================================="